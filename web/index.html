<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Minecraft Adventure</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #222;
      font-family: sans-serif;
      color: white;
      overflow: hidden;
    }
    #game {
      width: 100vw;
      height: 100vh;
    }
    #instructions {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      pointer-events: none;
      z-index: 10;
    }
    #controls {
      position: absolute;
      bottom: 80px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 10;
    }
    .btn-row {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .control-btn {
      width: 50px;
      height: 50px;
      font-size: 20px;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
      touch-action: manipulation;
    }
    .control-btn:active {
      background: #666;
    }
  </style>
</head>
<body>
<div id="game"></div>
<div id="instructions">
  <p><strong>Dùng W A S D</strong> hoặc nút ảo để di chuyển</p>
  <p><strong>Nhấn W</strong> hoặc nút W ảo để nhảy</p>
</div>
<div id="controls">
  <div class="btn-row">
    <button class="control-btn" id="btnW">W</button>
  </div>
  <div class="btn-row">
    <button class="control-btn" id="btnA">A</button>
    <button class="control-btn" id="btnS">S</button>
    <button class="control-btn" id="btnD">D</button>
  </div>
</div>

<script>
const TILE_SIZE = 32;
const WIDTH = 120;
const HEIGHT = 20;

const config = {
  type: Phaser.AUTO,
  width: TILE_SIZE * 30,
  height: TILE_SIZE * HEIGHT,
  parent: "game",
  backgroundColor: "#87ceeb",
  physics: {
    default: "arcade",
    arcade: {
      gravity: { y: 600 },
      debug: false
    }
  },
  scene: {
    preload,
    create,
    update
  }
};

let player1;
let keys;
let groundGroup;
let virtualKeys = {
  W: false,
  A: false,
  S: false,
  D: false,
};

const game = new Phaser.Game(config);

function preload() {
  this.load.image("sun", "https://i.imgur.com/8Q1YtZq.png");
}

function create() {
  const scene = this;

  scene.cameras.main.setBounds(0, 0, TILE_SIZE * WIDTH, TILE_SIZE * HEIGHT);
  scene.physics.world.setBounds(0, 0, TILE_SIZE * WIDTH, TILE_SIZE * HEIGHT);

  groundGroup = scene.physics.add.staticGroup();

  for (let x = 0; x < WIDTH; x++) {
    const groundY = Math.floor(12 + Math.sin(x * 0.3) * 3);
    for (let y = groundY; y < HEIGHT; y++) {
      const ground = groundGroup.create(
        x * TILE_SIZE + TILE_SIZE / 2,
        y * TILE_SIZE + TILE_SIZE / 2,
        null
      );
      ground.setSize(TILE_SIZE, TILE_SIZE);
      ground.setDisplaySize(TILE_SIZE, TILE_SIZE);
      ground.setFillStyle?.(0x228B22);
      ground.refreshBody();
    }
  }

  // Mặt trời
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      scene.add.rectangle(
        (WIDTH - 5 + j) * TILE_SIZE + TILE_SIZE / 2,
        (2 + i) * TILE_SIZE + TILE_SIZE / 2,
        TILE_SIZE,
        TILE_SIZE,
        0xFFD700
      );
    }
  }

  // Player
  player1 = scene.physics.add.sprite(100, 100, null);
  player1.setSize(TILE_SIZE, TILE_SIZE * 2);
  player1.setDisplaySize(TILE_SIZE, TILE_SIZE * 2);
  player1.setCollideWorldBounds(true);
  player1.setBounce(0.1);
  player1.setTint(0xff0000);

  scene.physics.add.collider(player1, groundGroup);

  keys = scene.input.keyboard.addKeys("W,A,S,D");

  scene.cameras.main.startFollow(player1);

  // Gán sự kiện cho nút ảo
  ["W", "A", "S", "D"].forEach(key => {
    const btn = document.getElementById("btn" + key);
    if (btn) {
      btn.addEventListener("touchstart", () => virtualKeys[key] = true);
      btn.addEventListener("touchend", () => virtualKeys[key] = false);
      btn.addEventListener("mousedown", () => virtualKeys[key] = true);
      btn.addEventListener("mouseup", () => virtualKeys[key] = false);
      btn.addEventListener("mouseleave", () => virtualKeys[key] = false);
    }
  });
}

function update() {
  const speed = 160;

  player1.setVelocityX(0);

  if (keys.A.isDown || virtualKeys.A) player1.setVelocityX(-speed);
  if (keys.D.isDown || virtualKeys.D) player1.setVelocityX(speed);

  if ((keys.W.isDown || virtualKeys.W ) && player1.body.touching.down) {
    player1.setVelocityY(-300);
  }
}
</script>
</body>
</html>